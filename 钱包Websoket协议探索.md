# 钱包Websoket协议探索

## 前言
由于单纯的Http协议无法满足钱包某些主动推送业务（如主动推送更新、广告、提示等），因此需借助soket来弥补。在传统长连接业务可选普通Soket和WebSoket，考虑到浏览器也能支持WebSoket，所以优先选择WebSoket。

## 要求
### 目标
* 接口“粒度”争取设计得足够小，争取在业务发生变化后，后台接口不需要增减，只需要前端组合接口仍然能满足新的业务需求。
* 任何一个接口都可以获取到数据，哪怕没传参数。

### 命名规范
一名二姓三风水，四积阴德五读书，名不正则言不顺，言不顺则事难成。软件开发其实就是门命名的艺术，所以首先定义一些规范，提出一些硬性要求，大家在命名的时候尽量多花点心思，多参考优秀的命名风格。
* 强烈推荐参考：[参考阿里巴巴Java开发手册](https://github.com/leguang/Article "阿里巴巴Java开发手册")，[Android开发规范](https://github.com/leguang/Article/blob/master/Android%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/Android%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.md "Android开发规范")，[iOS开发手册](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CodingGuidelines/CodingGuidelines.html "iOS开发手册")。
* 一个单词尽量选择5--7个字母的，这样才最优美。
* 首字母缩写的单词尽量每个字母都用大写，例如ID。用个小写，人家还以为是一个单词。当然uri、url、urn这种除外，因为大家都知道这个是什么。
* 规范并统一公司的基础包名与项目的关系。
* 前后端的某些名称概念要统一用某一个单词，比如支付的统一订单，支付宝用的是order，微信用的是unifiedorder，那我们统一对订单这个概念用order这个词。再比如主机：后台用gateway，现在我们统一用host。这单词不统一很容易分裂。

### uri规范
uri 表示资源，资源一般对应服务器端领域模型中的实体类，要求如下：
* 不用大写。
* 尽量不用横杠分隔符，万一要用，请使用中杠“-”不用下杠“_”。
* 参数列表要encode。
* uri中的名词表示资源集合，使用复数形式。
* 路径仅表示资源的路径（位置），以及一些特殊的actions操作。
* 以复数（名词）进行命名资源，不管返回单个或者多个资源。
* 资源的路径从父到子依次如：/{resource}/{resource_id}/{sub_resource}/{sub_resource_id}/{sub_resource_property}。
* 使用?来进行资源的过滤、搜索以及分页等。
* 使用版本号，且版本号在资源路径之前。
* 优先使用内容协商来区分表述格式，而不是使用后缀来区分表述格式。
* url最好越简短越好，结果过滤，排序，搜索相关的功能都应该通过参数实现。
* url失效则返回404 not found 或 410 gone；对迁移的API，返回 301 重定向。

### JSON规范
暂时只考虑json的数据格式，要求如下：
* 不要使用缩写。
* 统一用驼峰命名法。
* 不要使用“_”或者“-”。
* 用名词复数表示集合类型。
* 为了方便以后的扩展兼容，如果返回的是数组，强烈建议用一个包含如items属性的对象进行包裹。如：```{"items":[{},{}]}```。
* 建议对每个字段设置默认值（数组型可设置为[],字符串型可设置为””，数值可设置为0，对象可设置为{}）,这一条是为了方便前端/客户端进行判断字段存不存在操作。
* 建议资源使用UUID最为唯一标识。同时建议命名为id或者uid。
* 采用UTF-8编码。
* 数据应该拿来就能用，不应该还要进行转换操作。

>**草稿：JSON返回的格式是分门别类按对象来划分，还是铺大饼的形式铺开，两者利弊各异，比如url，可能一个接口中返回多个url，如果分json对象装的话，则key都可以叫url，否则的话key就得命名成xxxUrl。这个有待商议**

## WebSoket部分

### 使用场景

所有需要**双向通讯（确切的说是需要后台主动推送给前端的情景）**的部分都尽量使用WebSoket。

### 应用列举

理论上来说，对于数据的任何细微变化都应该有一个消息通过WebSoket传送出来，让客户端可以任意支配，此时的WebSoket就好比一个数据库的观察者，这样才能充分利用长连接，感知数据库的变化。当然实际中并不需要这么复杂，一般用于场景如：消息提醒、公司活动等。

### 格式

- 统一使用json。
- 无论是客户端发送给服务端还是服务端发送给客户端，都使用统一的json格式完成通讯。
- 兼容Http协议，若某个WebSoket传输的内容需要改成Http协议完成的话，可迅速兼容。
- 安全加密（后面会单独介绍）。

### URL结构
```
{版本号}/{业务名}
```
- {版本号} – 由于我们的业务未稳定，为了应对可能的协议变更，所以需要这个版本号来控制。
- {业务名} – 这个与同事们商议后定义一个方便后台通过反射调用方法的名称。

### 协议格式

与同事商议后得出一些结论，暂定格式如下：

#### 客户端-->服务端

```
{
    "message": "大王叫我来查询了",
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/getXXX",
    "data": {
        "uid": "6565656565665"
    }
}
```

|key | 类型 | 描述 |
| - | -| -|
|message | String | 返回给接口调用者的描述，有可能用于显示到界面上，需要进行国际化处理 |
|uid | String | 唯一标识该次请求或者响应，可以是时间戳，也可以是hash等，该字段如果是如果是前端传给后台的话，后台必须原样返回 |
|uri | String | 当分类使用，标记该次通讯的意义，类似Http协议中的URL，MQTT中的topic等，该字段如果是如果是前端传给后台的话，后台必须原样返回 |
|data | object | 当前接口的具体数据由该json对象承载 |
|uid | String | **对于每一个资源对象，在返回的时候，都应该返回操作这个资源对象的唯一码** |

#### 服务端-->客户端

```
{
    "message": "居然被你查询成功了",
    "code": 200,
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/getXXX",
    "data": {
        "uid": "6565656565665"
    }
}
```

|key | 类型 | 描述 |
| - | -| -|
|message | String | 返回给接口调用者的描述，有可能用于显示到界面上，需要进行国际化处理 |
|code | int | 这个与请求头中的状态码一致，是为了满足部分开发者的习惯 |
|uid | String | 唯一标识该次请求或者响应，可以是时间戳，也可以是hash等，该字段如果是如果是前端传给后台的话，后台必须原样返回 |
|uri | String | 当分类使用，标记该次通讯的意义，类似Http协议中的URL，MQTT中的topic等，该字段如果是如果是前端传给后台的话，后台必须原样返回 |
|data | object | 当前接口的具体数据由该json对象承载 |
|uid | String | **对于每一个资源对象，在返回的时候，都应该返回操作这个资源对象的唯一码** |

### 状态码
作为 API 的设计者，正确的将 API 执行结果和失败原因用清晰简洁的方式传达给客户程序是十分关键的一步。 我们可以模仿HTTP协议,在响应内容中描述是否成功，如果出错是因为什么，然而，这就意味着用户需要进行内容解析，才知道执行结果和错误原因。因此，响应码可以保证客户端在第一时间用最高效的方式获知 API 运行结果，并采取相应动作。下表列出了比较常用的响应代码。
常用的状态码及使用场景：

|响应码|代码含义|
| - | -|
|200|已创建，请求成功且服务器已创建了新的资源。|
|201|是否只显示处于警告状态的应用实例。|
|301|重定向 , 请求的网页已被永久移动到新位置。服务器返回此响应时，会自动将请求者转到新位置。|
|302|重定向 , 请求的网页临时移动到新位置，但求者应继续使用原有位置来进行以后的请求。302 会自动将请求者转到不同的临时位置。|
|304|未修改，自从上次请求后，请求的网页未被修改过。服务器返回此响应时，不会返回网页内容。|
|400|错误请求 , 服务器不理解请求的语法。|
|401|未授权 , 请求要求进行身份验证。|
|403|已禁止 , 服务器拒绝请求。|
|404|未找到 , 服务器找不到请求的网页。|
|405|方法禁用 , 禁用请求中所指定的方法。|
|406|不接受 , 无法使用请求的内容特性来响应请求的网页。|
|408|请求超时 , 服务器等候请求时超时。|
|410|已删除 , 如果请求的资源已被永久删除，那么，服务器会返回此响应。|
|412|未满足前提条件 , 服务器未满足请求者在请求中设置的其中一个前提条件。|
|415|不支持的媒体类型 , 请求的格式不受请求页面的支持。|
|500|内部服务器错误。|

## 具体业务

### 预览

![预览](https://i.imgur.com/ZoNmzun.png)

| 业务 | uri | 描述 |
| - | - | - |
|连接 | v1/connect | 由服务端主动推送过来，当连接成功后，后台会返回一些初始化数据，如token、加密的秘钥等 |
|断开连接 | v1/disconnect | 由客户端发送给服务端，当客户端退出时发送一个信号给服务端来关闭资源，做收尾处理 |
|心跳 | v1/heartbeat | 心跳包，可以是服务端发送给客户端，客户端返回，也可以是客户端发给服务端，服务端统计 |
|收账 | v1/receive | 由服务端主动推送过来，前端根据data里的内容主动收账 |
|自定义推送 | v1/notify | 由服务端主动推送过来，前端根据data里的内容创建通知显示 |
|广告活动 | v1/advertise | 由服务端主动推送过来，前端根据data里的内容主动弹框居中显示，此处预先设定好四种模板弹框：web图片弹框、web可交互弹框，原生图片弹框，原生可交互弹框 |
|简单即时通讯 | v1/im | 暂时不考虑（此处说的简单即时通讯是指用于一些简单双向通讯场景，比如社交中的回复，他人回复后客户端自动就能加载，比如反馈模块中用户反馈bug，客户迅速回复） |
|预留扩展 | v1/extra | 暂时不考虑 |
|登出/注销 | v1/logout | 由服务端主动推送过来，前端弹出登录界面 |

### 连接
在连接成功后，后台会返回一些初始化数据，这些数据包括token、session、秘钥等，客户端可以保存起来以备后用。

##### 响应
```
{
    "message": "恭喜你，连接成功",
    "code": 200,
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/connect",
    "data": {
        "token": "23523t23t23t23t23t"
    }
}
```

|key | 类型 | 描述 |
| - | -| -|
|token | String | 连接成功后，服务端会返回一个token，如果以后还有其他初始化数据的话，也会通过这个uri返回 |

### 断开连接
在退出App，或者关闭浏览器后，就由客户端发送这个uri给服务端，服务端就可以做一些收尾工作。

##### 响应
```
{
    "message": "请注意了，我要断开连接了",
    "uri": "v1/disconnect"
}
```

### 心跳
每隔1分钟，客户端主动发送一次心跳给服务端，服务端统计，如果间隔2次未收到心跳，即认为是客户端断开，即可断开连接，考虑到心跳的流量成本，因此心跳的数据尽量少。

##### 响应
```
{
    "uri": "v1/heartbeat"
}
```

### 收账
由服务端主动推送过来，服务端已经处理分析出链上的每一个块的变化与哪一个账户相关，然后推送到账户所在的手机上，手机端只要直接做刷新功能即可。

##### 响应
服务端-->客户端

```
{
    "code": 200,
    "data": {
        "account": "mol_1rf1umue1ugxz3akhz41dukp44deyybh3boh4byur1n3oot5j16511pgy7ue",
        "amount": "119340000000000000000000000000",
        "block": "{
    "type": "state",
    "account": "mol_1rf1umue1ugxz3akhz41dukp44deyybh3boh4byur1n3oot5j16511pgy7ue",
    "previous": "B34B6EA7FE4E832919FD1C3F63E24ABDD5B65C0DE99732497651ED2328A11601",
    "representative": "mol_3ytentj15q44he4c778317r868wdttwufp96fsccjux4tuqc59ojgrwn6d4w",
    "balance": "120329200000000000000000000000",
    "link": "67568C72C765DAF47A1427B976E5914C7B17FE2F8CC9779490FBDEFEC9E5DE01",
    "link_as_account": "mol_1stpjjsegsgtyjx3abxsguks4m5u4zz4z58bgycb3yyyzu6ydqi34kgefsif",
    "signature": "6547BD8CC1A16A484E083D4037EE77E7E463FDE358CF3FF2000CA2A40393271648D926B5CA143EA7CFE51178549C175575CFA9DC2864B3215753AFB4D2129F0F",
    "work": "a7556bb5e343ec87"
}
",
        "hash": "390C43CFB3E4B0F1E218CF023905D84985C6569348D873697E5C8D8610872C87",
        "is_send": "false"
    },
    "message": "XX收到多少MOL",
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/receive"
}
```

以上数据其实是将块信息放到data对象中，与手机中的type为state，subType为receive的块信息一样。

|key | 类型 | 描述 |
| - | -| -|
|account | String | 接收block的账户地址 |
|amount | String | 接收的总额 |
|block | String | block信息，其实又是一个json字符串 |
|hash | String | 该block的hash |
|is_send | String | 该block为非发送类型 |

### 自定义推送

#### 通知介绍
通知作为后台沟通手机端的一个桥梁，可以理解为后台撩前端的手段。我们在自定义通知的时候主要针对三大大类属性进行设置：
- 样式（style）：对应的通知的样式，一般包括图标，标题，内容，时间，甚至是自定义的布局。
- 动作（action）：用户滑动下拉框的动作，用户点击通知的后续动作，比如跳转界面，比如播放语音等。
一般的推送平台往往都提供设置这两样属性的Api，可以是前端设置，也可以是后端设置。
- 声音+震动：这些都是可以随意组合设置的。

#### 通知分类
按照是否自定义分为两大类：
- 默认通知（最常用）
- 自定义通知（针对特殊场景，如视频电话通知，跳转特定页面通知）。

##### 默认通知
![默认通知](https://i.imgur.com/QklBKdG.png)
 
这一类通知只需要提醒用户我们有发一个消息给他，有可能是广告，有可能是升级通知等。
样式：一般都只要基本的默认样式，即图标，标题，内容，时间。其中时间是到达前端的时间，后台不需要设置。
动作：只需要打开App即可。
pushRequest.setAndroidOpenType("APPLICATION");
如果填URL是为了给我们解析用的，就是跳特定页面的时候，前端人员可以根据这个URL来解析出路由路径。
声音+震动：默认就可以。

##### 特定通知
这类通知是某些样式特殊，如图片新闻通知，某些action特殊，比如点击跳转到特定页面，再比如微信的视频通话通知提醒，会不停的震动响铃一段时间等。此类通知我们暂无相关业务，可暂时不管。

#### 响应

```
{
    "message": "居然被你查询成功了",
    "code": 200,
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/notify",
    "data": {
        "title": "摩尔",
        "content": "摩尔",
        "when": "",
        "smallIcon": "",
        "largeIcon": "",
        "priority": "",
        "lights": "",
        "vibrate": "",
        "sound": "",
        "channel": ""
    }
}
```
|key | 类型 | 描述 |
| - | -| -|
|title | String | 通知标题 |
|content | String | 通知的长文内容 |
|when | String | 通知时间戳，（可以不用管，因为Android默认都是用系统时间） |
|smallIcon | String | 通知的右下角小图标（不用管，传个空就行了） |
|largeIcon | String | 通知的左边大图标（不用管，传个空就行了） |
|priority | String | 通知展示的优先级（不用管，传个空就行了,我这边统一用最大的） |
|lights | String | 控制呼吸灯颜色和闪烁行为（不用管，传个空就行了） |
|vibrate | String | 控制震动行为（不用管，传个空就行了） |
|sound | String | 控制声音（不用管，传个空就行了） |
|channel | String | 针对Android 8.0的 |

前端就可以利用这些数据生成一个自定义的本地通知显示在手机上。这样的话当用户的长连接存在的时候就可以不依赖第三方平台的推送厂商了。对于推送这一块，未来会有一个专门的消息中心模块来显示记录。

### 广告活动

#### 介绍
这部分是用于某些时刻主动给用户推送弹窗广告或者活动的，客户端会预先设计好四种弹窗模板：
- Web图片弹窗，即一个弹窗里装在一个WebView，直接显示即可，这类弹窗只是显示，没有交互（不会有点击跳转）。
- Web交互弹窗，即一个弹窗里装在一个WebView，直接显示网页内容，并且点击后可以跳转其他网页，当然这个跳转仍然在该弹窗内。
- native图片弹窗，即一个弹窗里装载一个显示图片的控件，直接显示即可，无其他交互。
- native交互弹窗，即一个特定的设计的弹窗，类似现在的挖矿每天第一次挖到第一笔MOL币时的弹窗，这个弹窗就是一个特殊的native交互式的弹窗，点击就跳转到了海报页面。

#### 响应

```
{
    "message": "弹广告了",
    "code": 200,
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/advertise",
    "data": {
        "type": "web",
        "url": "https://www.baidu.com/",
        …… 
    }
}
```

|key | 类型 | 描述 |
| - | - | - |
|type | String | web表示web弹窗，native表示native弹窗 |
|url | String | type为web是，url表示连接，为native时，如果是native图片弹框就表示图片的url |

### 登出/注销
考虑到账户的安全性和开发的便利性（比如原生与H5交互时，有这个功能则可避免在Web里token失效时还要弹出登录界面）需要这个功能来提示用户。

#### 响应

```
{
    "message": "您的账号于15:31在其他设备上登录",
    "code": 200,
    "uid": "A3BA3BA3BA3BC",
    "uri": "v1/logout"
}
```

#### 前端统一处理
1.类似QQ弹框提示已在其他地方登录，如图所示：

![其他地方登陆](https://i.imgur.com/jRThwdh.jpg)

2.用户点击“朕知道了”，则什么也不做，用户点击“重新登录”则弹出登录界面走登录流程。

## 安全

### 加密
对于传输的内容进行加解密，加密时机为传输数据前，解密时机为获取数据后，同时还要考虑随时可以去掉加解密，或者部分需要加密，部分不需要加密，因此前后端要采取相应的设计模式来做到充分易用。

要求秘钥是后台分发，可以考虑一连接成功就在那里返回

### 验签

参考

4.参考一下nano的websoket内容
