# 钱包二维码功能体系设计

## 前言
二维码本质上是一串字符的图形化展示，由于考虑到二维码的尺寸大小有限，其能容纳的字节数也有限，同时考虑到容错性，二维码点阵大小等能影响扫描结果、效率、准确性的因素，二维码包含的字符数不宜过多，参考微信和支付宝等项目和实践发现，字符串保证在40左右最佳，60以内比较合理。

## 业务简介
由于考虑到钱包的支付概念，因此应当具备类似微信支付、支付宝支付等生成二维码、扫描二维码等基本功能。具体业务如下图所示：

![功能预览](https://i.imgur.com/iKznLtn.png)

### 业务分析
整体按功能分类为：生成二维码和扫描二维码。

##### 生成二维码
根据最初设计的业务，钱包里的二维码体系无非就两种形式，一种是只有地址信息的，这样扫到之后就跳转到转账页面，一种是二维码中带有地址+金额参数的吗，这样就直接跳转到某一结果展示页面，然后确认支付。

1. 生成只带地址参数的二维码，由于之前的版本中的收款二维码略微粗糙，只是单纯将摩尔的64位地址生成二维码而已，当摩尔钱包App去扫描后，单纯的跳转到转账页面，并把地址填入到地址输入框内。现在考虑到更多的交互场景，就要考虑到兼容以前的版本了。

2. 生成带地址参数+金额参数，这个是以前版本没有的，直接按后面的讲解生成即可。

##### 扫描二维码
扫描功能的入口已经提到首页右上角，扫描的结果分析应该考虑以下两种情况：
1. 扫描到以前的mol_开头的单纯地址的二维码，则跳转到支付界面，将地址填入输入框内。（与之前一样）
2. 扫描到新版的（后面会讲协议）带地址参数的二维码，则跳转到支付界面，将地址填入输入框内。（与之前一样）
3. 扫描到新版的（后面会讲协议）带地址参数+金额参数的二维码，则跳转到新设计的结果展示页中。

### 实现方案
按照生成二维码和扫描二位码的分来详细讲解。

#### 生成二维码
以地址：```mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec``` 为例。

之前版本生成的二维码仅仅是将地址作为二维码内容，并没有其他协议规约，如下图所示：

![之前地址二维码](https://i.imgur.com/NyDnGXV.png) 

扫描出来的结果就是：```mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec```

但是这样设计有一个缺点就是当用户用第三方App，比如微信或者支付宝扫描后，只看到一个mol_开头的字符串，对于一个新用户来讲是懵逼的，也不利于我们导流。现在的用户一看到二维码第一反应应该是用微信扫一下，因此用户用微信扫到了结果后，可能直接就返回了，没有在意那么多，这一次扫描就浪费了。而理想的状态是分两种：

- 非摩尔用户

他不知道这个是什么，用第三方App（比如微信或者支付宝）扫一扫，或者在微信群里看到这个二维码就长按一下识别其中的内容，然后跳转到某个Web页面，该最好是产品的下载地址或者官网，里面附带一些介绍，这样的话就比单纯的字符串显示出来要有力得多。

- 摩尔用户

1. 他手机里安装了摩尔钱包App，当他看到二维码是来自摩尔体系的，用摩尔钱包里的扫一扫，然后跳转到相应的结果界面来响应。或者用第三方App（比如微信或者支付宝）扫描，引导到浏览器里能调起摩尔App。
2. 他手机里没有安装摩尔钱包App，他看到二维码后，用第三方App（比如微信或者支付宝）扫描后跳转到产品下载下面，或者官网。

总上所述，考虑到带有“扫一扫”功能的App，一般只要扫到的内容是url就会跳转到web，其他协议的uri就看本应用有没有相应的匹配处理，如果没有就直接显示出该字符串。所以利用这一点，我们尽量把协议涉及成url形式，即scheme为http协议的uri。

##### 生成只带地址参数的二维码
以地址：```mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec``` 为例。a是address的缩写。http和https都可以，协议设计如下：
> http://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec

或者：

> https://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec

如下图所示：

![只带地址的二维码协议](https://i.imgur.com/PkhdHLH.png)

此时用第三方App扫描则会跳转到我们指定的url，在该url，我们就可以根据User Agent来做相应的跳转或者显示。

##### 生成带地址参数+金额参数的二维码

以地址：```mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec``` ，金额：10MOL 为例。考虑到未来会有智能合约进行ICO，因此出现金额则必带币种参数。a是address的缩写，t是totle的缩写，c是currency的缩写。http和https都可以，协议设计如下：

> http://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec&t=10&c=mol

或者：

> https://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec&t=10&c=mol

如下图所示：

![带金额参数的二维码协议](https://i.imgur.com/WwbEZpJ.png)

#### 扫描二维码

##### 摩尔钱包App扫描

扫描后的结果要进行严格的检测和解析处理，利用正则和url解析来确保程序的鲁棒性，不允许出现无响应结果、甚至是程序崩溃。考虑到兼容性，在摩尔钱包App内，对于扫描结果以及相应处理如下表所示：

| 扫描类型 | 扫描示例 | 相应处理 |
| - | - | - |
| 单纯地址 | mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec | 直接跳转到转账地址页面，并把地址填入到地址输入框中 |
| 带地址参数 | https://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec | 直接跳转到转账地址页面，并把地址填入到地址输入框中 |
| 带地址+金额 | https://qr.mol.one?a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec&t=10&c=mol | 直接跳转到新设计的展示页面，点击确定后就走支付流程 |
| 其他url | 比如HTTPS://QR.ALIPAY.COM/FKX03220E6XSYYDVDVYK16 | 直接跳转到WebView打开就不管了 |
| 其他任意数据 | 比如wxp://f2f0EzisVnmgig6_R1MqIY_Uqr8j1FwhGLT3或者861256413232 | 直接显示（需商讨怎么显示） |

**草稿：对于扫描结果这块，考虑到有可能加了新的协议，而老的版本的App没有相应的功能，因此，有一个默认的结果展示页，跳转到一个连接，然后在连接中展示，是该提示升级还是直接展示扫描结果，同时要考虑到网络异常问题，如果异常就直接展示扫描出来的字符结果。**

##### 第三方App扫描我们的二维码
由于我们的二维码都是url，因此最终都会集中访问到 http://qr.mol.one 这个地址下，到时候熊老师会在这个地址下通过js根据请求跳转到不同的页面，如下表所示：

| 请求 | 扫描示例 |
| - | - |
| 微信 | 引导用浏览器打开（有一层遮罩提示） |
| Android浏览器 | 跳转到Android下载页面 |
| iPhone浏览器 | 跳转到iOS下载页面 |
| PC | 跳转到官网主页，这种情况一般是某些技术人员把二维码扫出来后，用PC浏览器打开 |

### 优化
考虑到二维码所能容纳的字符数有限，同时字符数越多，点阵越密集，扫描体验越差，因此应当尽量缩短字符，又由于二维码中必须包含地址参数，而光一个地址就有64个字符，导致无论怎么设计字符数都难以降低，因此考虑压缩一下，争取时间换取空间。

在经过一些列的斗争后，发现自创的压缩算法不行，会出现很多符号，这样对传播不利，因此暂时不考虑该路径优化。

### 扩展

对于优化部分的无力，只能借助网络来弥补，可以通过网络传输来传递更多的字符，适应更复杂的场景。思路如下：

1. 准备好本该封装到二维码中的参数，如a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec&t=10&c=mol
2. 由于字符太多，二维码不方便显示，转而上传到数据库中，并返回一个唯一ID，如：123456789，
3. 然后将唯一ID配合 https://qr.mol.one 拼成一个字符，如： https://qr.mol.one?123456789 ，生成的二维码如下图所示：
![唯一ID](https://i.imgur.com/JZxWwdw.png)

4. 当其他用户用摩尔钱包App扫描后，解析取出ID作为参数123456789，
5. 访问数据库得到对应ID的本该封装到二维码中的参数，如：a=mol_15tcgzxmwg1d7rs91gc58um8y5jpz85g7iikdemnzimyrm5w6rw7krpeuxec&t=10&c=mol，然后做相应的处理。

流程如下：

![二维码生成流程](https://i.imgur.com/xzZmHiX.png)

这样一来就可以很好的扩展，二维码只是一个中间传播参数的介质。
